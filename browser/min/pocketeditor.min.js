"use strict";(()=>{function P(e,t){for(let[n,i]of Object.entries(t))if(e.startsWith(`${i} `))return n;return""}function C(e,t){let n=document.createDocumentFragment();t=t.replaceAll("	","");for(let i of t.split(`

`)){if(i.indexOf(`
`)===-1){n.appendChild(e.createLine({text:i,modif:P(i,e.mods)}));continue}for(let o of i.split(`
`))n.appendChild(e.createLine({text:o,modif:P(o,e.mods)}))}return n}function M(e){function t(r){return r.dataset.list===""?"- ":r.dataset.h1===""?"# ":r.dataset.h2===""?"## ":r.dataset.h3===""?"### ":r.dataset.todoChecked===""?"[x] ":r.dataset.todo===""?"[ ] ":""}let n="",i="",o=r=>r?.dataset.list||r?.dataset.todo;return e.forEach((r,s)=>{if(r.textContent==="pe-mock-selection")return;i=t(r),n+=i+r.textContent;let m=o(e[s+1])&&o(r),c=e.length-1===s;n+=c?"":m?`
`:`

`}),n}function k(e){let t=e;for(;t?.childNodes.length>0;){let n=Object.values(t.childNodes).reverse(),i=n.filter(o=>o.nodeName==="#text");if(i.length>0)return i[0];t=n[0]}return t}function v(e,t){let n=k(e),i=window.getSelection(),o=document.createRange(),r=n.nodeValue?.length||0;o.setStart(n,t?0:r),o.setEnd(n,t?0:r),i?.removeAllRanges(),i?.addRange(o),i?.collapseToEnd()}var S=[];function w(e,t){let n=e.lines,i=M(n),o=t?n.indexOf(t):0;i!==S[0]?.markdown&&(S.unshift({markdown:i,index:o}),S.length>50&&S.pop())}function W(e){let t;new MutationObserver(()=>{t&&clearTimeout(t)}).observe(e.container,{characterData:!0,subtree:!0}),e.container.addEventListener("keydown",i=>{(i.ctrlKey||i.metaKey)&&i.key==="z"&&(t=window.setTimeout(()=>{z(e)},1))})}function z(e){let{markdown:t,index:n}=S[0]??{};if(t){for(let i of Object.values(e.container.children))i.remove();e.container.appendChild(C(e,t)),setTimeout(()=>{let i=e.container.querySelectorAll("[contenteditable]")[n];i&&(i.focus(),v(i,!1))},0),S.shift(),e.container.dispatchEvent(new InputEvent("input",{inputType:"insertText",bubbles:!0,data:""}))}}function _(e,t){let n=e.getSelectedLines();n.length>0&&(t.clipboardData?.setData("text/plain",M(n)),t.preventDefault())}function B(e,t){let n=e.getSelectedLines();n.length>0&&(t.clipboardData?.setData("text/plain",M(n)),t.preventDefault(),e.removeLines(n),w(e,n[n.length-1]))}function K(e,t){t.preventDefault();let n=window.getSelection(),i=n?.getRangeAt(0),o=t.clipboardData?.getData("text")||"";if(P(o,e.mods)!==""){let r=t.target,s=C(e,o),m=s.childElementCount-1,c=e.getLineFromEditable(r),d=e.getSelectedLines();if(d.length>0&&(c=d[d.length-1]),c?.parentElement?.dataset.pocketEditor===void 0)return;e.container.insertBefore(s,e.getNextLine(c));let l=c.nextSibling;for(let f=0;f<m;f++)l&&(l=l.nextSibling);if(l&&v(l),c&&c.textContent===""){let f=u=>{let p=c?.dataset[u]===u,h=e.getNextLine(c)?.dataset[u]===u;return p===h};(c||f("list")||f("todo")||f("todo-checked"))&&c.remove()}e.container.dispatchEvent(new InputEvent("input",{inputType:"insertText",bubbles:!0,data:""}));return}if(n?.rangeCount&&i){let r=n?.anchorOffset??0,s=n.focusNode?.nodeValue??"";s&&n.focusNode?(n.focusNode.nodeValue=s.slice(0,r)+o+s.slice(r),n.collapse(n.focusNode,r+o.length)):(i.insertNode(document.createTextNode(o)),v(i.endContainer))}e.container.dispatchEvent(new InputEvent("input",{inputType:"insertText",bubbles:!0,data:""}))}function A(e){let t=document.createElement("div"),n=e.parentElement;if(n){delete n.dataset.list,delete n.dataset.todo,delete n.dataset.h1,delete n.dataset.h2,delete n.dataset.h3,delete n.dataset.todoChecked,t.textContent=n.textContent,t.setAttribute("contenteditable","true");for(let i of Object.values(n.childNodes))i.remove();return n.appendChild(t),t.focus(),t}}function H(e,t,n,i=!0){if(!n)return;let o=e.getLineFromEditable(t);if(!o||o?.dataset[n])return;switch(o.querySelector("span[data-list-marker]")?.remove(),o.querySelector("span[data-todo-marker]")?.remove(),delete o.dataset.h1,delete o.dataset.h2,delete o.dataset.h3,delete o.dataset.list,delete o.dataset.todo,delete o.dataset.todoChecked,n){case"h1":case"h2":case"h3":r(n);break;case"list":m();break;case"todo":s(!1);break;case"todo-checked":s(!0);break;default:}function r(c){let d=document.createElement(c),l=c==="h1"?"#":c==="h2"?"##":"###";d.textContent=t.textContent?.replace(l,"").trimStart()||"",d.setAttribute("contenteditable","true"),o&&(o.dataset[c]="",t.replaceWith(d)),i&&v(d)}function s(c){let d=document.createElement("input"),l=document.createElement("span"),f=document.createElement("p"),u=e.getLineFromEditable(t),p=(t.textContent??"").replace(e.ZERO_WIDTH_WHITESPACE,"");!u||u.dataset.todo||((p.startsWith("[ ]")||p.startsWith("[x]"))&&(p=p.slice(4,p.length)),d.type="checkbox",d.name="checkbox",d.setAttribute("aria-label","todo list checkbox"),d.addEventListener("input",()=>{d.checked?(u.setAttribute("data-todo-checked",""),d.setAttribute("checked","")):(u.removeAttribute("data-todo-checked"),u.setAttribute("data-todo",""),d.removeAttribute("checked"))}),c&&(d.setAttribute("checked",""),u.dataset.todoChecked=""),u.dataset.todo="",l.dataset.todoMarker="",f.textContent=p,f.setAttribute("contenteditable","true"),t.replaceWith(f),l.appendChild(d),u.prepend(l),i&&v(f))}function m(){let c=document.createElement("span"),d=document.createElement("p"),l=(t.textContent??"").replace(e.ZERO_WIDTH_WHITESPACE,"");!o||o.dataset.list===""||(l.startsWith("-")&&(l=l?.replace("-","").trimStart()),o.dataset.list="",c.dataset.content="\u2022",c.dataset.listMarker="",d.textContent=l,d.setAttribute("contenteditable","true"),t.replaceWith(d),o.prepend(c),i&&v(d))}}function O(e,t){let n=e.container,i=t.target,o;try{let l=i?.hasAttribute("contenteditable"),f=i?.tagName==="INPUT";if(o=window.getSelection()?.getRangeAt(0),!(o&&l)||f)throw new Error("?")}catch{return}let r=e.getLineFromEditable(i),s=Object.keys(r?.dataset??{}),m=t?.inputType==="insertParagraph",c=t?.inputType==="insertText",d;if(t.type==="beforeinput"&&m&&r){t.preventDefault(),w(e,r);let l=(i.textContent??"").replace(e.ZERO_WIDTH_WHITESPACE,""),f=l.slice(0,o.startOffset),u=l.slice(o.startOffset);if((o.startOffset===0||l===""&&o.startOffset===1)&&s.length>0){A(i);return}r.dataset.todo===""&&(d="todo"),r.dataset.list===""&&(d="list"),r.dataset.todoChecked===""&&(d="todo");let h=e.getNextLine(r),g=e.createLine({text:u,modif:d});h?n.insertBefore(g,h):n?.appendChild(g),g.querySelector("[contenteditable]")?.focus(),i.textContent=f,n.dispatchEvent(new InputEvent("input",{inputType:"insertText",bubbles:!0,data:""}));return}if(t.type==="input"&&c){let f=(i?.textContent??"").replace("\u200B","");for(let[u,p]of Object.entries(e.mods))(f.startsWith(p+" ")||f.startsWith(p+"\xA0"))&&(d=u,H(e,i,d))}}function N(e,t){let n=!t.key.includes("Arrow"),i=!window.getSelection()?.anchorNode;if(n||i)return;let o=t.target,r=e.getLineFromEditable(o),s=window?.getSelection()?.getRangeAt(0),m=s?.startContainer?.nodeValue?.length??0;if(!(s&&r))return;let c=e.getPrevLine(r),d=e.getNextLine(r),l=Math.min(s?.endOffset,s?.startOffset)===0,f=Math.max(s?.endOffset,s?.startOffset)===m,u=t.key==="ArrowLeft"&&l&&c,p=t.key==="ArrowRight"&&f&&d;if(u)return{line:r,dir:"up"};if(p)return{line:r,dir:"down"};let h=!1,g=!1,L=s?.getBoundingClientRect(),y=r?.getBoundingClientRect();!(y&&L)||L.y===0?(h=!0,g=!0):(h=y.top-L.top+L.height>0,g=L.bottom+L.height-y.bottom>0);let E=t.key==="ArrowUp"&&c&&h,b=t.key==="ArrowDown"&&d&&g;if(E)return{line:r,dir:"up"};if(b)return{line:r,dir:"down"}}function q(e){let t=e.lines,n,i=[-1,-1],o=-1,r=-1;function s(a){clearTimeout(n),n=window.setTimeout(()=>{a()},200)}function m(a){if(a||(a=e.getSelectedLines()),a.length===0)return;document.querySelector("#pocket-editor-mock-sel")?.remove();let E=document.createElement("pre");E.id="pocket-editor-mock-sel",E.textContent="pe-mock-selection",E.setAttribute("contenteditable","true"),e.container.appendChild(E);let b=window.getSelection(),x=document.createRange(),T=E.childNodes[0].nodeValue?.length||0;x.setStart(E.childNodes[0],0),x.setEnd(E.childNodes[0],T),b?.removeAllRanges(),b?.addRange(x)}function c(a){let E=e.getLineFromEditable(a);return E?t.indexOf(E):-1}function d(){let a=t[o];a?.querySelector("[contenteditable]")&&v(a),o=-1,r=-1,i=[-1,-1],document.querySelector("#pocket-editor-mock-sel")?.remove(),e.container.removeEventListener("mousemove",g)}function l(a){a>r&&(i[1]=a),a<r&&(i[0]=a),a===r&&(i=[a,a])}function f(a){r=a,i=[a,a]}function u(a){t.forEach((E,b)=>{b>=a[0]&&b<=a[1]?E.setAttribute("data-selected",""):E.removeAttribute("data-selected")}),s(()=>m())}function p(a){o=r=a,i=[a,a]}function h(a){t=e.lines;let E=e.getSelectedLines(),b=a.key.match(/([x|c|v])/g),x=a.key==="Control"||a.key==="Meta",T=E.length>0,R=a.ctrlKey||a.metaKey;if(x||R&&b&&T)return;if(R&&a.key==="a"){window.getSelection()?.removeAllRanges(),o=r=0,i=[0,t.length-1],u(i),a.preventDefault();return}if(T){if(window.getSelection()?.removeAllRanges(),a.key==="Escape"||a.key==="Tab"){d(),u(i),a.preventDefault();return}if(a.key.includes("Arrow")){a.key.includes("Down")&&(o=Math.min(o+1,t.length-1)),a.key.includes("Up")&&(o=Math.max(0,o-1)),a.shiftKey&&l(o),a.shiftKey||f(o),u(i),a.preventDefault();return}J(a.code,"Shift","Alt","Control","Caps")||(d(),w(e,E[E.length- -1]),e.removeLines(E),a.code==="Enter"&&a.preventDefault())}if(!a.shiftKey)return;let{line:I}=N(e,a)??{};if(I){let Z=t.indexOf(I);p(Z),u(i),window.getSelection()?.removeAllRanges()}}function g(a){let E=a.target,b=e.getSelectedLines();b.length>0&&window.getSelection()?.removeAllRanges();let x=E.getAttribute("aria-label")==="todo list checkbox",T=E.dataset.listMarker,R=!!E.getAttribute("contenteditable");if(x||T||R){if(o=c(E),o===r&&b.length===0)return;l(o),u(i)}}function L(a){let E=a.target,b=a.button===2,x=a.button===0,T=e.getSelectedLines().length>0;t=e.lines,b&&a.preventDefault(),x&&(T&&(d(),u(i)),E.getAttribute("contenteditable")&&(p(c(E)),e.container.addEventListener("mousemove",g)))}function y(a){let E=a.composedPath(),b=e.getSelectedLines().length>0;!E.includes(e.container)&&b&&(t=e.lines,d(),u(i)),e.container.removeEventListener("mousemove",g)}window.addEventListener("touchend",y),window.addEventListener("click",y),e.container.addEventListener("keydown",h),e.container.addEventListener("mousedown",L)}function J(e,...t){for(let n of t)if(e.includes(n))return!0;return!1}function $(e,t){v(t),e.parentElement?.remove()}function X(e,t){let n=k(t),i=n.nodeType===3,o=n.nodeValue?.length||0,r=e?.textContent||"";n[i?"nodeValue":"textContent"]+=r;let s=window.getSelection(),m=document.createRange();m.setStart(n,i?o:0),m.setEnd(n,i?o:0),s?.removeAllRanges(),s?.addRange(m),e.parentElement.remove()}function j(e){let t="ontouchstart"in window||navigator.maxTouchPoints>0,n=navigator.userAgent.toLowerCase(),i=window.getSelection();function o(r){let s=r.target,m=e.getLineFromEditable(s),c="ontouchstart"in window||navigator.maxTouchPoints>0,d=!!s.getAttribute("contenteditable"),l=i?.getRangeAt(0)?.endOffset===0,f=r.inputType==="deleteContentBackward";if(r.type==="beforeinput"&&!f||!l||!d)return;if(r.preventDefault(),m&&w(e,m),Object.keys(m?.dataset??{}).length>0){let h=A(s);c&&h&&h.textContent===""&&(h.textContent=e.ZERO_WIDTH_WHITESPACE,v(h));return}let p=e.getPrevLine(m);p&&(s.textContent===""?$(s,p):X(s,p),e.container.dispatchEvent(new InputEvent("beforeinput",{inputType:"deleteContentBackward",bubbles:!0})))}if(e.container.addEventListener("beforeinput",o),n.includes("safari")&&!(n.includes("chrome")&&n.includes("chromium"))&&e.container.addEventListener("keydown",r=>{try{let s=i?.getRangeAt(0),m=r.key==="Backspace",c=s?.startOffset===0;m&&c&&o(r)}catch{}}),t){let r=!1;e.container.addEventListener("beforeinput",s=>{let m=s.target,c=s.inputType==="deleteContentBackward",d=m.textContent===e.ZERO_WIDTH_WHITESPACE;c&&d&&(r=!0)}),e.container.addEventListener("keyup",s=>{let m=s.target;if(r){r=!1,o(s);return}m.textContent===""&&(m.textContent=e.ZERO_WIDTH_WHITESPACE,v(m))})}}function V(e){let t=0;function n(){let r=document.createElement("p"),s=document.createElement("span");r.id="pocket-editor-mock-p",s.textContent="abcdefghijklmnopqrstuvwxyz0123456789",r?.appendChild(s),e.container.querySelector(".line [contenteditable]")?.appendChild(r),t=s.offsetWidth/36/2,r.remove()}function i(r,s){let m=window.getSelection(),c=-1,d=U(m,r),l=e.caret_x??d.offset,f=r?.querySelector("[contenteditable]"),u=k(f),p=document.createRange();p.setStart(u,0),p.setEnd(u,0);let h=0;for(let g=0;g<s.length-1;g++){try{p.setStart(u,g),p.setEnd(u,g)}catch{break}if(h=p.getBoundingClientRect().x-d.editable,h+t>=l){c=g;break}}return c}function o(r){let s=r?.querySelector("[contenteditable]");if(!s)return console.warn("Couldn't get string[], no contenteditable found"),[];let m=0,c=0,d=0,l=[""],f=(s.textContent??"").split(" "),u=k(s),p=document.createRange();p.setStart(u,0),p.setEnd(u,0);let h=navigator.userAgent.includes("AppleWebKit");d=c=p.getBoundingClientRect().y;for(let g of f){g=`${g} `,m+=g.length;try{p.setStart(u,m),p.setEnd(u,m),c=p.getBoundingClientRect().y}catch{}h&&(l[0]+=g),c>d&&(h&&(l[0]=l[0].trimEnd()),l.unshift(""),d=c),h===!1&&(l[0]+=g)}return l.reverse(),l}e.container.addEventListener("pointerdown",()=>{e.caret_x=void 0}),e.container.addEventListener("keydown",r=>{if(!r.key.includes("Arrow"))return;let s=r.key==="ArrowRight",m=r.key==="ArrowLeft",{line:c,dir:d}=N(e,r)??{},l=window.getSelection(),f=document.createRange(),u=document.createTextNode(""),p=0;if(m||s?e.caret_x=void 0:e.caret_x===void 0&&(e.caret_x=U(l,c).offset),!!c){if(t===0&&n(),d==="down"){let h=e.getNextLine(c)??c;u=k(h);let g=u.nodeValue?.length||0;if(!s){let L=o(h);p=i(h,L[0])??-1,p<0&&(p=g)}}if(d==="up"){let h=e.getPrevLine(c)??c;u=k(h);let g=u.nodeValue?.length||0;if(p=g,!m){let L=o(h),y=L[L.length-1].trimEnd(),a=i(h,y)??g;p=g-(y.length-a),a<0&&(p=g)}}try{f.setStart(u,p),f.setEnd(u,p),l?.removeAllRanges(),l?.addRange(f),l?.collapseToEnd(),r.preventDefault()}catch{console.warn("Cannot set caret")}}})}function U(e,t){let n=!e?.anchorNode;if(!t||n)return{editable:0,range:0,offset:0};let o=t.querySelector("[contenteditable]")?.getBoundingClientRect().x??0,r=e?.getRangeAt(0)?.cloneRange()?.getBoundingClientRect().x??0;return{editable:o,range:r,offset:r-o}}function F(e,t){let n=t.target,o=(t.ctrlKey||t.metaKey)&&t.shiftKey&&t.code.includes("Digit"),r=e.getLineFromEditable(n);if(o&&n){let s=Number.parseInt(t.code.replace("Digit",""))-1,c=Object.keys(e.mods)[s];if(r?.hasAttribute(`data-${c}`)||s===5){t.preventDefault(),A(n);return}c in e.mods&&c!=="todo-checked"&&(t.preventDefault(),H(e,n,c))}}var D=class{container;lines;wrapper;caret_x;ZERO_WIDTH_WHITESPACE="\u200B";mods={h1:"#",h2:"##",h3:"###",list:"-",todo:"[ ]","todo-checked":"[x]"};constructor(t,n){let i=document.createElement("div"),{text:o,defer:r,id:s}=n??{};if(this.wrapper=typeof t=="string"?document.querySelector(t):t,this.container=i,this.lines=[],this.wrapper===null)throw new Error(`Pocket editor: selector "${t}" was not found`);s&&(i.id=s),i.dataset.pocketEditor="",typeof r=="number"?setTimeout(()=>this.init(o),r):r===!0?setTimeout(()=>this.init(o)):this.init(o)}init(t){t?this.container.appendChild(C(this,t)):this.container.appendChild(this.createLine({text:""})),this.wrapper&&this.wrapper.appendChild(this.container),this.container.addEventListener("beforeinput",o=>O(this,o)),this.container.addEventListener("input",o=>O(this,o)),this.container.addEventListener("keydown",o=>F(this,o)),this.container.addEventListener("paste",o=>K(this,o)),this.container.addEventListener("copy",o=>_(this,o)),this.container.addEventListener("cut",o=>B(this,o)),q(this),V(this),j(this),W(this);let n=()=>{this.lines=Object.values(this.container.children)};new MutationObserver(n).observe(this.container,{childList:!0}),this.lines=Object.values(this.container.children)}get value(){return M(this.lines)}set value(t){for(let n of Object.values(this.container.children))n.remove();this.container.appendChild(C(this,t))}oninput(t){let n=i=>{if(i.type==="beforeinput"){let s=i.inputType;(s==="deleteContentBackward"||s==="insertParagraph")&&queueMicrotask(()=>{t(this.value),console.log(this.value)});return}t(this.value)};return this.container.addEventListener("cut",n),this.container.addEventListener("paste",n),this.container.addEventListener("input",n),this.container.addEventListener("beforeinput",n),()=>{this.container.removeEventListener("cut",n),this.container.removeEventListener("paste",n),this.container.removeEventListener("input",n),this.container.removeEventListener("beforeinput",n)}}addEventListener(t,n){return this.oninput(n)}getSelectedLines(){return this.lines.filter(t=>t.dataset.selected!==void 0)??[]}getPrevLine(t){return this.lines[this.lines.indexOf(t)-1]}getNextLine(t){return this.lines[this.lines.indexOf(t)+1]}getLineFromEditable(t){for(;t?.parentElement;){let n=t.parentElement;if(n.tagName==="DIV")return n;t=n}return null}removeLines(t){let n=this.createLine(),i=this.getPrevLine(t[0]);for(let o of t)o.remove();i?this.insertAfter(n,i):this.container.prepend(n),v(n),this.container.dispatchEvent(new InputEvent("input",{inputType:"deleteContent",bubbles:!0,data:""}))}createLine(t){let n=document.createElement("div"),i=document.createElement("p"),o=t?.modif??"",r=this.mods;return i.setAttribute("contenteditable","true"),n.appendChild(i),typeof t?.text=="string"&&(i.textContent=t.text),o in r&&H(this,i,o,!1),n}insertAfter(t,n){n?.parentNode?.insertBefore(t,n.nextSibling)}},qt=D;globalThis.PocketEditor=D;})();
