"use strict";(()=>{function P(e,t){for(let[n,o]of Object.entries(t))if(e.startsWith(`${o} `))return n;return""}function C(e,t){let n=document.createDocumentFragment();t=t.replaceAll("	","");for(let o of t.split(`

`)){if(o.indexOf(`
`)===-1){n.appendChild(e.createLine({text:o,modif:P(o,e.mods)}));continue}for(let i of o.split(`
`))n.appendChild(e.createLine({text:i,modif:P(i,e.mods)}))}return n}function S(e){function t(r){return r.dataset.list===""?"- ":r.dataset.h1===""?"# ":r.dataset.h2===""?"## ":r.dataset.h3===""?"### ":r.dataset.todoChecked===""?"[x] ":r.dataset.todo===""?"[ ] ":""}let n="",o="",i=r=>r?.dataset.list||r?.dataset.todo;return e.forEach((r,a)=>{o=t(r),n+=o+r.textContent;let p=i(e[a+1])&&i(r),c=e.length-1===a;n+=c?"":p?`
`:`

`}),n}function k(e){let t=e;for(;t?.childNodes.length>0;){let n=Object.values(t.childNodes).reverse(),o=n.filter(i=>i.nodeName==="#text");if(o.length>0)return o[0];t=n[0]}return t}function v(e,t){let n=k(e),o=window.getSelection(),i=document.createRange(),r=n.nodeValue?.length||0;i.setStart(n,t?0:r),i.setEnd(n,t?0:r),o?.removeAllRanges(),o?.addRange(i),o?.collapseToEnd()}var M=[];function w(e,t){let n=e.lines,o=S(n),i=t?n.indexOf(t):0;o!==M[0]?.markdown&&(M.unshift({markdown:o,index:i}),M.length>50&&M.pop())}function W(e){let t;new MutationObserver(()=>{t&&clearTimeout(t)}).observe(e.container,{characterData:!0,subtree:!0}),e.container.addEventListener("keydown",o=>{(o.ctrlKey||o.metaKey)&&o.key==="z"&&(t=window.setTimeout(()=>{z(e)},1))})}function z(e){let{markdown:t,index:n}=M[0]??{};if(t){for(let o of Object.values(e.container.children))o.remove();e.container.appendChild(C(e,t)),setTimeout(()=>{let o=e.container.querySelectorAll("[contenteditable]")[n];o&&(o.focus(),v(o,!1))},0),M.shift(),e.container.dispatchEvent(new InputEvent("input",{inputType:"insertText",bubbles:!0,data:""}))}}function _(e,t){let n=e.getSelectedLines();n.length>0&&(t.clipboardData?.setData("text/plain",S(n)),t.preventDefault())}function K(e,t){let n=e.getSelectedLines();n.length>0&&(t.clipboardData?.setData("text/plain",S(n)),t.preventDefault(),e.removeLines(n),w(e,n[n.length-1]))}function B(e,t){t.preventDefault();let n=window.getSelection(),o=n?.getRangeAt(0),i=t.clipboardData?.getData("text")||"";if(P(i,e.mods)!==""){let r=t.target,a=C(e,i),p=a.childElementCount-1,c=e.getLineFromEditable(r),d=e.getSelectedLines();if(d.length>0&&(c=d[d.length-1]),!c?.parentElement?.dataset.pocketEditor)return;e.container.insertBefore(a,e.getNextLine(c));let l=c.nextSibling;for(let f=0;f<p;f++)l&&(l=l.nextSibling);if(l&&v(l),c&&c.textContent===""){let f=u=>{let m=c?.dataset[u]===u,h=e.getNextLine(c)?.dataset[u]===u;return m===h};(c||f("list")||f("todo")||f("todo-checked"))&&c.remove()}e.container.dispatchEvent(new InputEvent("input",{inputType:"insertText",bubbles:!0,data:""}));return}if(n?.rangeCount&&o){let r=n?.anchorOffset??0,a=n.focusNode?.nodeValue??"";a&&n.focusNode?(n.focusNode.nodeValue=a.slice(0,r)+i+a.slice(r),n.collapse(n.focusNode,r+i.length)):(o.insertNode(document.createTextNode(i)),v(o.endContainer))}e.container.dispatchEvent(new InputEvent("input",{inputType:"insertText",bubbles:!0,data:""}))}function A(e){let t=document.createElement("div"),n=e.parentElement;if(n){delete n.dataset.list,delete n.dataset.todo,delete n.dataset.h1,delete n.dataset.h2,delete n.dataset.h3,delete n.dataset.todoChecked,t.textContent=n.textContent,t.setAttribute("contenteditable","true");for(let o of Object.values(n.childNodes))o.remove();return n.appendChild(t),t.focus(),t}}function H(e,t,n,o=!0){if(!n)return;let i=e.getLineFromEditable(t);if(!i||i?.dataset[n])return;switch(i.querySelector("span[data-list-marker]")?.remove(),i.querySelector("span[data-todo-marker]")?.remove(),delete i.dataset.h1,delete i.dataset.h2,delete i.dataset.h3,delete i.dataset.list,delete i.dataset.todo,delete i.dataset.todoChecked,n){case"h1":case"h2":case"h3":r(n);break;case"list":p();break;case"todo":a(!1);break;case"todo-checked":a(!0);break;default:}function r(c){let d=document.createElement(c),l=c==="h1"?"#":c==="h2"?"##":"###";d.textContent=t.textContent?.replace(l,"").trimStart()||"",d.setAttribute("contenteditable","true"),i&&(i.dataset[c]="",t.replaceWith(d)),o&&v(d)}function a(c){let d=document.createElement("input"),l=document.createElement("span"),f=document.createElement("p"),u=e.getLineFromEditable(t),m=(t.textContent??"").replace(e.ZERO_WIDTH_WHITESPACE,"");!u||u.dataset.todo||((m.startsWith("[ ]")||m.startsWith("[x]"))&&(m=m.slice(4,m.length)),d.type="checkbox",d.name="checkbox",d.setAttribute("aria-label","todo list checkbox"),d.addEventListener("input",()=>{d.checked?(u.setAttribute("data-todo-checked",""),d.setAttribute("checked","")):(u.removeAttribute("data-todo-checked"),u.setAttribute("data-todo",""),d.removeAttribute("checked"))}),c&&(d.setAttribute("checked",""),u.dataset.todoChecked=""),u.dataset.todo="",l.dataset.todoMarker="",f.textContent=m,f.setAttribute("contenteditable","true"),t.replaceWith(f),l.appendChild(d),u.prepend(l),o&&v(f))}function p(){let c=document.createElement("span"),d=document.createElement("p"),l=(t.textContent??"").replace(e.ZERO_WIDTH_WHITESPACE,"");!i||i.dataset.list===""||(l.startsWith("-")&&(l=l?.replace("-","").trimStart()),i.dataset.list="",c.dataset.content="\u2022",c.dataset.listMarker="",d.textContent=l,d.setAttribute("contenteditable","true"),t.replaceWith(d),i.prepend(c),o&&v(d))}}function O(e,t){let n=e.container,o=t.target,i;try{let l=o?.hasAttribute("contenteditable"),f=o?.tagName==="INPUT";if(i=window.getSelection()?.getRangeAt(0),!(i&&l)||f)throw new Error("?")}catch{return}let r=e.getLineFromEditable(o),a=Object.keys(r?.dataset??{}),p=t?.inputType==="insertParagraph",c=t?.inputType==="insertText",d;if(t.type==="beforeinput"&&p&&r){t.preventDefault(),w(e,r);let l=(o.textContent??"").replace(e.ZERO_WIDTH_WHITESPACE,""),f=l.slice(0,i.startOffset),u=l.slice(i.startOffset);if((i.startOffset===0||l===""&&i.startOffset===1)&&a.length>0){A(o);return}r.dataset.todo===""&&(d="todo"),r.dataset.list===""&&(d="list"),r.dataset.todoChecked===""&&(d="todo");let h=e.getNextLine(r),g=e.createLine({text:u,modif:d});h?n.insertBefore(g,h):n?.appendChild(g),g.querySelector("[contenteditable]")?.focus(),o.textContent=f,n.dispatchEvent(new InputEvent("input",{inputType:"insertText",bubbles:!0,data:""}));return}if(t.type==="input"&&c){let f=(o?.textContent??"").replace("\u200B","");for(let[u,m]of Object.entries(e.mods))(f.startsWith(m+" ")||f.startsWith(m+"\xA0"))&&(d=u,H(e,o,d))}}function N(e,t){let n=!t.key.includes("Arrow"),o=!window.getSelection()?.anchorNode;if(n||o)return;let i=t.target,r=e.getLineFromEditable(i),a=window?.getSelection()?.getRangeAt(0),p=a?.startContainer?.nodeValue?.length??0;if(!(a&&r))return;let c=e.getPrevLine(r),d=e.getNextLine(r),l=Math.min(a?.endOffset,a?.startOffset)===0,f=Math.max(a?.endOffset,a?.startOffset)===p,u=t.key==="ArrowLeft"&&l&&c,m=t.key==="ArrowRight"&&f&&d;if(u)return{line:r,dir:"up"};if(m)return{line:r,dir:"down"};let h=!1,g=!1,L=a?.getBoundingClientRect(),y=r?.getBoundingClientRect();!(y&&L)||L.y===0?(h=!0,g=!0):(h=y.top-L.top+L.height>0,g=L.bottom+L.height-y.bottom>0);let E=t.key==="ArrowUp"&&c&&h,b=t.key==="ArrowDown"&&d&&g;if(E)return{line:r,dir:"up"};if(b)return{line:r,dir:"down"}}function q(e){let t=e.lines,n,o=[-1,-1],i=-1,r=-1;function a(s){clearTimeout(n),n=window.setTimeout(()=>{s()},200)}function p(s){if(s||(s=e.getSelectedLines()),s.length===0)return;document.querySelector("#pocket-editor-mock-sel")?.remove();let E=document.createElement("pre");E.id="pocket-editor-mock-sel",E.textContent="mock-selection",E.setAttribute("contenteditable","true"),e.container.appendChild(E);let b=window.getSelection(),x=document.createRange(),T=E.childNodes[0].nodeValue?.length||0;x.setStart(E.childNodes[0],0),x.setEnd(E.childNodes[0],T),b?.removeAllRanges(),b?.addRange(x)}function c(s){let E=e.getLineFromEditable(s);return E?t.indexOf(E):-1}function d(){let s=t[i];s?.querySelector("[contenteditable]")&&v(s),i=-1,r=-1,o=[-1,-1],document.querySelector("#pocket-editor-mock-sel")?.remove(),e.container.removeEventListener("mousemove",g)}function l(s){s>r&&(o[1]=s),s<r&&(o[0]=s),s===r&&(o=[s,s])}function f(s){r=s,o=[s,s]}function u(s){t.forEach((E,b)=>{b>=s[0]&&b<=s[1]?E.setAttribute("data-selected",""):E.removeAttribute("data-selected")}),a(()=>p())}function m(s){i=r=s,o=[s,s]}function h(s){t=e.lines;let E=e.getSelectedLines(),b=s.key.match(/([x|c|v])/g),x=s.key==="Control"||s.key==="Meta",T=E.length>0,R=s.ctrlKey||s.metaKey;if(x||R&&b&&T)return;if(R&&s.key==="a"){window.getSelection()?.removeAllRanges(),i=r=0,o=[0,t.length-1],u(o),s.preventDefault();return}if(T){if(window.getSelection()?.removeAllRanges(),s.key==="Escape"||s.key==="Tab"){d(),u(o),s.preventDefault();return}if(s.key.includes("Arrow")){s.key.includes("Down")&&(i=Math.min(i+1,t.length-1)),s.key.includes("Up")&&(i=Math.max(0,i-1)),s.shiftKey&&l(i),s.shiftKey||f(i),u(o),s.preventDefault();return}J(s.code,"Shift","Alt","Control","Caps")||(d(),w(e,E[E.length- -1]),e.removeLines(E),s.code==="Enter"&&s.preventDefault())}if(!s.shiftKey)return;let{line:I}=N(e,s)??{};if(I){let Z=t.indexOf(I);m(Z),u(o),window.getSelection()?.removeAllRanges()}}function g(s){let E=s.target,b=e.getSelectedLines();b.length>0&&window.getSelection()?.removeAllRanges();let x=E.getAttribute("aria-label")==="todo list checkbox",T=E.dataset.listMarker,R=!!E.getAttribute("contenteditable");if(x||T||R){if(i=c(E),i===r&&b.length===0)return;l(i),u(o)}}function L(s){let E=s.target,b=s.button===2,x=s.button===0,T=e.getSelectedLines().length>0;t=e.lines,b&&s.preventDefault(),x&&(T&&(d(),u(o)),E.getAttribute("contenteditable")&&(m(c(E)),e.container.addEventListener("mousemove",g)))}function y(s){let E=s.composedPath(),b=e.getSelectedLines().length>0;!E.includes(e.container)&&b&&(t=e.lines,d(),u(o)),e.container.removeEventListener("mousemove",g)}window.addEventListener("touchend",y),window.addEventListener("click",y),e.container.addEventListener("keydown",h),e.container.addEventListener("mousedown",L)}function J(e,...t){for(let n of t)if(e.includes(n))return!0;return!1}function $(e,t){v(t),e.parentElement?.remove()}function X(e,t){let n=k(t),o=n.nodeType===3,i=n.nodeValue?.length||0,r=e?.textContent||"";n[o?"nodeValue":"textContent"]+=r;let a=window.getSelection(),p=document.createRange();p.setStart(n,o?i:0),p.setEnd(n,o?i:0),a?.removeAllRanges(),a?.addRange(p),e.parentElement.remove()}function j(e){let t="ontouchstart"in window||navigator.maxTouchPoints>0,n=navigator.userAgent.toLowerCase(),o=window.getSelection();function i(r){let a=r.target,p=e.getLineFromEditable(a),c="ontouchstart"in window||navigator.maxTouchPoints>0,d=!!a.getAttribute("contenteditable"),l=o?.getRangeAt(0)?.endOffset===0,f=r.inputType==="deleteContentBackward";if(r.type==="beforeinput"&&!f||!l||!d)return;if(r.preventDefault(),p&&w(e,p),Object.keys(p?.dataset??{}).length>0){let h=A(a);c&&h&&h.textContent===""&&(h.textContent=e.ZERO_WIDTH_WHITESPACE,v(h));return}let m=e.getPrevLine(p);m&&(a.textContent===""&&$(a,m),a.textContent!==""&&X(a,m))}if(e.container.addEventListener("beforeinput",i),n.includes("safari")&&!(n.includes("chrome")&&n.includes("chromium"))&&e.container.addEventListener("keydown",r=>{try{let a=o?.getRangeAt(0),p=r.key==="Backspace",c=a?.startOffset===0;p&&c&&i(r)}catch{}}),t){let r=!1;e.container.addEventListener("beforeinput",a=>{let p=a.target,c=a.inputType==="deleteContentBackward",d=p.textContent===e.ZERO_WIDTH_WHITESPACE;c&&d&&(r=!0)}),e.container.addEventListener("keyup",a=>{let p=a.target;if(r){r=!1,i(a);return}p.textContent===""&&(p.textContent=e.ZERO_WIDTH_WHITESPACE,v(p))})}}function V(e){let t=0;function n(){let r=document.createElement("p"),a=document.createElement("span");r.id="pocket-editor-mock-p",a.textContent="abcdefghijklmnopqrstuvwxyz0123456789",r?.appendChild(a),e.container.querySelector(".line [contenteditable]")?.appendChild(r),t=a.offsetWidth/36/2,r.remove()}function o(r,a){let p=window.getSelection(),c=-1,d=U(p,r),l=e.caret_x??d.offset,f=r?.querySelector("[contenteditable]"),u=k(f),m=document.createRange();m.setStart(u,0),m.setEnd(u,0);let h=0;for(let g=0;g<a.length-1;g++){try{m.setStart(u,g),m.setEnd(u,g)}catch{break}if(h=m.getBoundingClientRect().x-d.editable,h+t>=l){c=g;break}}return c}function i(r){let a=r?.querySelector("[contenteditable]");if(!a)return console.warn("Couldn't get string[], no contenteditable found"),[];let p=0,c=0,d=0,l=[""],f=(a.textContent??"").split(" "),u=k(a),m=document.createRange();m.setStart(u,0),m.setEnd(u,0);let h=navigator.userAgent.includes("AppleWebKit");d=c=m.getBoundingClientRect().y;for(let g of f){g=`${g} `,p+=g.length;try{m.setStart(u,p),m.setEnd(u,p),c=m.getBoundingClientRect().y}catch{}h&&(l[0]+=g),c>d&&(h&&(l[0]=l[0].trimEnd()),l.unshift(""),d=c),h===!1&&(l[0]+=g)}return l.reverse(),l}e.container.addEventListener("pointerdown",()=>{e.caret_x=void 0}),e.container.addEventListener("keydown",r=>{if(!r.key.includes("Arrow"))return;let a=r.key==="ArrowRight",p=r.key==="ArrowLeft",{line:c,dir:d}=N(e,r)??{},l=window.getSelection(),f=document.createRange(),u=document.createTextNode(""),m=0;if(p||a?e.caret_x=void 0:e.caret_x===void 0&&(e.caret_x=U(l,c).offset),!!c){if(t===0&&n(),d==="down"){let h=e.getNextLine(c)??c;u=k(h);let g=u.nodeValue?.length||0;if(!a){let L=i(h);m=o(h,L[0])??-1,m<0&&(m=g)}}if(d==="up"){let h=e.getPrevLine(c)??c;u=k(h);let g=u.nodeValue?.length||0;if(m=g,!p){let L=i(h),y=L[L.length-1].trimEnd(),s=o(h,y)??g;m=g-(y.length-s),s<0&&(m=g)}}try{f.setStart(u,m),f.setEnd(u,m),l?.removeAllRanges(),l?.addRange(f),l?.collapseToEnd(),r.preventDefault()}catch{console.warn("Cannot set caret")}}})}function U(e,t){let n=!e?.anchorNode;if(!t||n)return{editable:0,range:0,offset:0};let i=t.querySelector("[contenteditable]")?.getBoundingClientRect().x??0,r=e?.getRangeAt(0)?.cloneRange()?.getBoundingClientRect().x??0;return{editable:i,range:r,offset:r-i}}function F(e,t){let n=t.target,i=(t.ctrlKey||t.metaKey)&&t.shiftKey&&t.code.includes("Digit"),r=e.getLineFromEditable(n);if(i&&n){let a=Number.parseInt(t.code.replace("Digit",""))-1,c=Object.keys(e.mods)[a];if(r?.hasAttribute(`data-${c}`)||a===5){t.preventDefault(),A(n);return}c in e.mods&&c!=="todo-checked"&&(t.preventDefault(),H(e,n,c))}}var D=class{container;lines;wrapper;caret_x;ZERO_WIDTH_WHITESPACE="\u200B";mods={h1:"#",h2:"##",h3:"###",list:"-",todo:"[ ]","todo-checked":"[x]"};constructor(t,n){let o=document.createElement("div"),{text:i,defer:r,id:a}=n??{};if(this.wrapper=typeof t=="string"?document.querySelector(t):t,this.container=o,this.lines=[],this.wrapper===null)throw new Error(`Pocket editor: selector "${t}" was not found`);a&&(o.id=a),o.dataset.pocketEditor="",typeof r=="number"?setTimeout(()=>this.init(i),r):r===!0?setTimeout(()=>this.init(i)):this.init(i)}init(t){t?this.container.appendChild(C(this,t)):this.container.appendChild(this.createLine({text:""})),this.wrapper&&this.wrapper.appendChild(this.container),this.container.addEventListener("beforeinput",i=>O(this,i)),this.container.addEventListener("input",i=>O(this,i)),this.container.addEventListener("keydown",i=>F(this,i)),this.container.addEventListener("paste",i=>B(this,i)),this.container.addEventListener("copy",i=>_(this,i)),this.container.addEventListener("cut",i=>K(this,i)),q(this),V(this),j(this),W(this);let n=()=>{this.lines=Object.values(this.container.children)};new MutationObserver(n).observe(this.container,{childList:!0}),this.lines=Object.values(this.container.children)}get value(){return S(this.lines)}set value(t){for(let n of Object.values(this.container.children))n.remove();this.container.appendChild(C(this,t))}oninput(t){let n=this;return this.container.addEventListener("cut",o),this.container.addEventListener("paste",o),this.container.addEventListener("input",o),this.container.addEventListener("beforeinput",o),()=>{this.container.removeEventListener("cut",o),this.container.removeEventListener("paste",o),this.container.removeEventListener("input",o),this.container.removeEventListener("beforeinput",o)};function o(i){i.type==="beforeinput"&&!i.inputType.match(/(deleteContentBackward|insertParagraph)/g)||t(n.value)}}addEventListener(t,n){return this.oninput(n)}getSelectedLines(){return this.lines.filter(t=>t.dataset.selected!==void 0)??[]}getPrevLine(t){return this.lines[this.lines.indexOf(t)-1]}getNextLine(t){return this.lines[this.lines.indexOf(t)+1]}getLineFromEditable(t){for(;t?.parentElement;){let n=t.parentElement;if(n.tagName==="DIV")return n;t=n}return null}removeLines(t){let n=this.createLine(),o=this.getPrevLine(t[0]);for(let i of t)i.remove();o?this.insertAfter(n,o):this.container.prepend(n),v(n),this.container.dispatchEvent(new InputEvent("input",{inputType:"deleteContent",bubbles:!0,data:""}))}createLine(t){let n=document.createElement("div"),o=document.createElement("p"),i=t?.modif??"",r=this.mods;return o.setAttribute("contenteditable","true"),n.appendChild(o),typeof t?.text=="string"&&(o.textContent=t.text),i in r&&H(this,o,i,!1),n}insertAfter(t,n){n?.parentNode?.insertBefore(t,n.nextSibling)}},qt=D;globalThis.PocketEditor=D;})();
